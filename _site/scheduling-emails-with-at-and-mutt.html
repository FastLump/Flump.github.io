<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <link href='http://fonts.googleapis.com/css?family=PT+Serif:400,700,400italic' rel='stylesheet' type='text/css'>
  <link href='http://fonts.googleapis.com/css?family=PT+Sans:400,700,400italic' rel='stylesheet' type='text/css'>
  <link href='http://fonts.googleapis.com/css?family=Droid+Sans+Mono' rel='stylesheet' type='text/css'>

  <title>Brian Buccola &middot; Scheduling emails with at and mutt</title>
  <meta name="description" content="I had assumed that most modern email services, like Gmail, allow users toschedule emails to be sent at some later specified time, but a quick Googlesearch re...">

  <link rel="stylesheet" href="/css/main.css">
  <link rel="canonical" href="http://brianbuccola.com/scheduling-emails-with-at-and-mutt">
  <link rel="alternate" type="application/rss+xml" title="Brian Buccola" href="http://brianbuccola.com/feed.xml">

  <!-- mathjax config similar to math.stackexchange -->
  <script src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML" type="text/javascript"></script>
</head>


  <body>

    <header class="site-header">

  <div class="wrapper">

    <!-- <a class="site-title" href="/">Brian Buccola</a> -->

    <nav class="site-nav">
      <a href="#" class="menu-icon">
        <svg viewBox="0 0 18 15">
          <path fill="#424242" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
          <path fill="#424242" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484 h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
          <path fill="#424242" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
        </svg>
      </a>

      <div class="trigger">
        <a class="page-link" href="/">Home</a>
        <a class="page-link" href="/about">About</a>
        <a class="page-link" href="/news">News</a>
        <a class="page-link" href="/work">Work</a>
        <a class="page-link" href="/files/buccola-cv.pdf">CV</a>
        <a class="page-link" href="/contact">Contact</a>
        <a class="page-link" href="/blog">Blog</a>
        <a class="page-link" href="/feed.xml"><span class="icon icon--feed"><?xml version="1.0"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd"> 
<svg xmlns="http://www.w3.org/2000/svg" version="1.1" width="128px" height="128px" id="RSSicon" viewBox="0 0 256 256">
<defs>
<linearGradient x1="0.085" y1="0.085" x2="0.915" y2="0.915" id="RSSg">
<stop  offset="0.0" stop-color="#E3702D"/><stop  offset="0.1071" stop-color="#EA7D31"/>
<stop  offset="0.3503" stop-color="#F69537"/><stop  offset="0.5" stop-color="#FB9E3A"/>
<stop  offset="0.7016" stop-color="#EA7C31"/><stop  offset="0.8866" stop-color="#DE642B"/>
<stop  offset="1.0" stop-color="#D95B29"/>
</linearGradient>
</defs>
<rect width="256" height="256" rx="55" ry="55" x="0"  y="0"  fill="#CC5D15"/>
<rect width="246" height="246" rx="50" ry="50" x="5"  y="5"  fill="#F49C52"/>
<rect width="236" height="236" rx="47" ry="47" x="10" y="10" fill="url(#RSSg)"/>
<circle cx="68" cy="189" r="24" fill="#FFF"/>
<path d="M160 213h-34a82 82 0 0 0 -82 -82v-34a116 116 0 0 1 116 116z" fill="#FFF"/>
<path d="M184 213A140 140 0 0 0 44 73 V 38a175 175 0 0 1 175 175z" fill="#FFF"/>
</svg>
</span></a>
      </div>
    </nav>

  </div>

</header>


    <div class="page-content">
      <div class="wrapper">
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title" itemprop="name headline">Scheduling emails with at and mutt</h1>
    <p class="post-meta"><time datetime="2013-01-04T11:08:00+02:00" itemprop="datePublished">Jan 4, 2013</time></p>
  </header>

  <div class="post-content" itemprop="articleBody">
    <p>I had assumed that most modern email services, like Gmail, allow users to
schedule emails to be sent at some later specified time, but a quick Google
search reveals that that’s not quite the case. It looks like you need to use a
browser extension like <a href="http://www.boomeranggmail.com/">Boomerang</a> or <a href="http://www.rightinbox.com/">Right Inbox</a>.</p>

<p>But what if you don’t trust browser extensions/third parties to handle private
emails?  Or what if you don’t use Firefox, Chrome, etc.? (I use <a href="http://portix.bitbucket.org/dwb/">dwb</a>.) In
this post I’ll explain how Linux users who are already set up with <a href="http://www.mutt.org/">mutt</a> (or
any mail client with similar command-line capability) can harness the powers of
<code class="highlighter-rouge">at</code> and <code class="highlighter-rouge">mutt</code> to schedule emails.</p>

<p>The <code class="highlighter-rouge">at</code> command lets you schedule tasks (shell commands) that are to be
executed at a specified time. The basic syntax is <code class="highlighter-rouge">at TIMESPEC</code>, where timespec
is something like <code class="highlighter-rouge">now + 10 minutes</code>, <code class="highlighter-rouge">noon tomorrow</code>, <code class="highlighter-rouge">11:59pm Dec 31</code>, etc.
The <code class="highlighter-rouge">at</code> command is run from a terminal, and once you specify the timespec and
hit enter, you’re put into an interactive prompt where you list the commands
that you want <code class="highlighter-rouge">at</code> to execute at the specified time. Hit <code class="highlighter-rouge">&lt;Ctrl-D&gt;</code> to finish,
or <code class="highlighter-rouge">&lt;Ctrl-C&gt;</code> to cancel. For example:</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="gp">$ </span>at now + 1 minute
warning: commands will be executed using /bin/sh
<span class="gp">at&gt; </span><span class="nb">echo</span> <span class="s2">"testing out at"</span> &gt;&gt;~/my-at-test
<span class="gp">at&gt; </span>&lt;EOT&gt;
job 13 at Fri Jan  4 11:46:00 2013
</code></pre>
</div>

<p>In the above code, we tell <code class="highlighter-rouge">at</code> that 1 minute from now, it should append the
text “testing out at” to the file <code class="highlighter-rouge">my-at-test</code> (and create it if it doesn’t
already exist).<sup id="fnref:atd"><a href="#fn:atd" class="footnote">1</a></sup></p>

<p>You can run <code class="highlighter-rouge">atq</code> to view the queue of current jobs, <code class="highlighter-rouge">atrm JOBID</code> to remove a
job, and <code class="highlighter-rouge">at -c JOBID</code> to view (<strong>c</strong>at) a queued job.</p>

<p>Since <code class="highlighter-rouge">at</code> accepts any shell command, we can schedule emails using mutt’s
command-line interface. The basic syntax for sending emails with mutt from the
command line is</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="gp">$ </span><span class="nb">echo</span> <span class="s2">"MSG"</span> | mutt -s SUBJ -- RECIPIENT <span class="c"># for simple messages</span>
<span class="gp">$ </span>mutt -s SUBJ -- RECIPIENT &lt;MSG         <span class="c"># for longer messages (files)</span>
</code></pre>
</div>

<p>Suppose I want to email myself a reminder tomorrow at 10am to call John. Here’s
what I do.<sup id="fnref:alias"><a href="#fn:alias" class="footnote">2</a></sup></p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="gp">$ </span>at 10am tomorrow
warning: commands will be executed using /bin/sh
<span class="gp">at&gt; </span><span class="nb">echo</span> <span class="s2">"Remember to call John."</span> | mutt -s <span class="s2">"Call John"</span> -- me
<span class="gp">at&gt; </span>&lt;EOT&gt;
job 14 at Sat Jan  5 10:00:00 2013
</code></pre>
</div>

<p>There’s a problem though. If my computer is off tomorrow at 10am, nothing will
happen. And if my computer is on but not connected to the internet, then the
job will technically be executed (and thus be subsequently removed from the
queue), but no mail will be sent.</p>

<p>Moreover, if my computer is off tomorrow at 10am, then <code class="highlighter-rouge">at</code> will execute the
command the next time I boot, but unfortunately it’ll do so immediately, before
enough time has passed to allow my wifi connection to be established.</p>

<p>There’s really no complete remedy to these problems except to ensure that the
computer is on and connected to the internet at the specified time (which is no
problem for people who rarely turn off their computers, or for dedicated
servers).</p>

<p>But if the computer is off and/or not online, there is still a way to ensure
that the email is not sent until a wifi connection is established.  We just
need to write a simple shell script, <code class="highlighter-rouge">check-wifi.sh</code>, which only exits once a
wifi connection is established.</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="c">#!/bin/bash</span>

<span class="k">until</span> <span class="o">[[</span> -n <span class="s2">"</span><span class="k">$(</span>iwgetid<span class="k">)</span><span class="s2">"</span> <span class="o">]]</span>; <span class="k">do
    </span>sleep 1
<span class="k">done

</span><span class="nb">exit </span>0
</code></pre>
</div>

<p><code class="highlighter-rouge">iwgetid</code> is a command that returns the ESSID of the current wifi connection if
there is one, and nothing otherwise. So this script does the following: keep
waiting (sleeping) until <code class="highlighter-rouge">iwgetid</code> returns a string of nonzero length, then
exit with status 0. (Remember to make it executable: <code class="highlighter-rouge">chmod a+x
check-wifi.sh</code>.)</p>

<p>Now we can modify our <code class="highlighter-rouge">at</code> commands as follows:</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="gp">$ </span>at 10am tomorrow
<span class="gp">at&gt; </span>/path/to/check-wifi.sh
<span class="gp">at&gt; </span><span class="nb">echo</span> <span class="s2">"Remember to call John."</span> | mutt -s <span class="s2">"Call John"</span> -- me
<span class="gp">at&gt; </span>&lt;EOT&gt;
</code></pre>
</div>

<p>Now the email won’t try to be delivered until <code class="highlighter-rouge">check-wifi.sh</code> finishes running,
i.e., until a wifi connection is established.</p>

<p>We can also modify <code class="highlighter-rouge">check-wifi.sh</code> to time out after, say, 3 minutes of no
wifi, and to write something to a log file.</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="c">#!/bin/bash</span>

<span class="nv">COUNT</span><span class="o">=</span>0
<span class="nv">TIMEOUT</span><span class="o">=</span>180
<span class="nv">E_TIMEOUT</span><span class="o">=</span>70

<span class="k">until</span> <span class="o">[[</span> -n <span class="s2">"</span><span class="k">$(</span>iwgetid<span class="k">)</span><span class="s2">"</span> <span class="o">]]</span>; <span class="k">do
    </span>sleep 1
    <span class="nb">let</span> <span class="s2">"COUNT+=1"</span>
    <span class="c"># wait $TIMEOUT seconds, then exit</span>
    <span class="k">if</span> <span class="o">[[</span> <span class="nv">$COUNT</span> -ge <span class="nv">$TIMEOUT</span> <span class="o">]]</span>; <span class="k">then
        </span><span class="nb">echo</span> <span class="s2">"</span><span class="k">$(</span>date <span class="s1">'+%F %T'</span><span class="k">)</span><span class="s2"> </span><span class="se">\</span><span class="s2">
            Wifi connection not established. No mail sent."</span> &gt;&gt;~/.at.log
        <span class="nb">exit</span> <span class="nv">$E_TIMEOUT</span>
    <span class="k">fi
done

</span><span class="nb">exit </span>0
</code></pre>
</div>

<p>The result of all this is that I can schedule an email for, say, 6am tomorrow,
when my computer is probably off, and it’ll get delivered the moment I boot up
and connect to the internet. Or I can schedule a birthday email for 6am on
John’s birthday, and it’ll get sent the moment I boot up and get online,
assuming I do so on John’s birthday.</p>

<p>As you can see, the possibilities with <code class="highlighter-rouge">at</code>, mutt, and shell scripting are
endless.</p>
<div class="footnotes">
  <ol>
    <li id="fn:atd">
      <p><code class="highlighter-rouge">at</code> comes with a daemon, <code class="highlighter-rouge">atd</code>, which must be running in order to
    schedule and execute commands.  If you get the error</p>

      <div class="highlighter-rouge"><pre class="highlight"><code>Can't open /var/run/atd.pid to signal atd. No atd running?
</code></pre>
      </div>

      <p>then it means <code class="highlighter-rouge">atd</code> is not running. Either run <code class="highlighter-rouge">sudo atd</code> to run <code class="highlighter-rouge">atd</code> just
this once, or do whatever is necessary to have <code class="highlighter-rouge">atd</code> load on boot. (In Arch
Linux: <code class="highlighter-rouge">sudo systemctl enable atd.service</code>.) <a href="#fnref:atd" class="reversefootnote">&#8617;</a></p>
    </li>
    <li id="fn:alias">
      <p>I have <code class="highlighter-rouge">me</code> aliased to my email address in <code class="highlighter-rouge">~/.mutt/alias</code>, which is
      sourced in <code class="highlighter-rouge">.muttrc</code>. <a href="#fnref:alias" class="reversefootnote">&#8617;</a></p>
    </li>
  </ol>
</div>

  </div>

</article>

      </div>
    </div>

    <footer class="site-footer">
  <div class="wrapper">
    <div class="footer-wrapper">
      &copy; Brian Buccola. Powered by <a
         href="https://jekyllrb.com/">Jekyll</a> and <a
         href="https://github.com/">GitHub</a>.
    </div>
  </div>
</footer>


  </body>

</html>
