<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <link href='http://fonts.googleapis.com/css?family=PT+Serif:400,700,400italic' rel='stylesheet' type='text/css'>
  <link href='http://fonts.googleapis.com/css?family=PT+Sans:400,700,400italic' rel='stylesheet' type='text/css'>
  <link href='http://fonts.googleapis.com/css?family=Droid+Sans+Mono' rel='stylesheet' type='text/css'>

  <title>Brian Buccola &middot; Maintaining an academic website, part 2: pushing to server</title>
  <meta name="description" content="This is the second in a series of posts on how I currently maintain my academicwebsite (here). In the first post, I explained how I writeand edit my site usi...">

  <link rel="stylesheet" href="/css/main.css">
  <link rel="canonical" href="http://brianbuccola.com/maintaining-an-academic-website-part-2-pushing-to-server">
  <link rel="alternate" type="application/rss+xml" title="Brian Buccola" href="http://brianbuccola.com/feed.xml">

  <!-- mathjax config similar to math.stackexchange -->
  <script src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML" type="text/javascript"></script>
</head>


  <body>

    <header class="site-header">

  <div class="wrapper">

    <!-- <a class="site-title" href="/">Brian Buccola</a> -->

    <nav class="site-nav">
      <a href="#" class="menu-icon">
        <svg viewBox="0 0 18 15">
          <path fill="#424242" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
          <path fill="#424242" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484 h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
          <path fill="#424242" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
        </svg>
      </a>

      <div class="trigger">
        <a class="page-link" href="/">Home</a>
        <a class="page-link" href="/about">About</a>
        <a class="page-link" href="/news">News</a>
        <a class="page-link" href="/work">Work</a>
        <a class="page-link" href="/files/buccola-cv.pdf">CV</a>
        <a class="page-link" href="/contact">Contact</a>
        <a class="page-link" href="/blog">Blog</a>
        <a class="page-link" href="/feed.xml"><span class="icon icon--feed"><?xml version="1.0"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd"> 
<svg xmlns="http://www.w3.org/2000/svg" version="1.1" width="128px" height="128px" id="RSSicon" viewBox="0 0 256 256">
<defs>
<linearGradient x1="0.085" y1="0.085" x2="0.915" y2="0.915" id="RSSg">
<stop  offset="0.0" stop-color="#E3702D"/><stop  offset="0.1071" stop-color="#EA7D31"/>
<stop  offset="0.3503" stop-color="#F69537"/><stop  offset="0.5" stop-color="#FB9E3A"/>
<stop  offset="0.7016" stop-color="#EA7C31"/><stop  offset="0.8866" stop-color="#DE642B"/>
<stop  offset="1.0" stop-color="#D95B29"/>
</linearGradient>
</defs>
<rect width="256" height="256" rx="55" ry="55" x="0"  y="0"  fill="#CC5D15"/>
<rect width="246" height="246" rx="50" ry="50" x="5"  y="5"  fill="#F49C52"/>
<rect width="236" height="236" rx="47" ry="47" x="10" y="10" fill="url(#RSSg)"/>
<circle cx="68" cy="189" r="24" fill="#FFF"/>
<path d="M160 213h-34a82 82 0 0 0 -82 -82v-34a116 116 0 0 1 116 116z" fill="#FFF"/>
<path d="M184 213A140 140 0 0 0 44 73 V 38a175 175 0 0 1 175 175z" fill="#FFF"/>
</svg>
</span></a>
      </div>
    </nav>

  </div>

</header>


    <div class="page-content">
      <div class="wrapper">
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title" itemprop="name headline">Maintaining an academic website, part 2: pushing to server</h1>
    <p class="post-meta"><time datetime="2013-03-02T11:08:00+02:00" itemprop="datePublished">Mar 2, 2013</time></p>
  </header>

  <div class="post-content" itemprop="articleBody">
    <p>This is the second in a series of posts on how I currently maintain my academic
website (<a href="http://people.linguistics.mcgill.ca/~brian.buccola/">here</a>). In the <a href="2013-02-23-maintaining-an-academic-website-part-1-editing-the-site.html">first post</a>, I explained how I write
and edit my site using the simple and intuitive syntax of <a href="http://daringfireball.net/projects/markdown/">markdown</a>, rather
than pure HTML, and convert from markdown to HTML using <a href="http://johnmacfarlane.net/pandoc/">pandoc</a>. I also
explained how I modularize my website into (i) main content, the stuff written
in markdown, which evolves over time, and (ii) metacontent, which is kept in
separate header, footer, etc. files, which is more static; and I showed how
pandoc can combine all such content into one standalone HTML page. I gave a
pretty basic script for automating all that each time any part of the site is
edited.</p>

<p>In this post I’ll explain how to automate another important aspect of site
maintenance: pushing the website from your local PC to the remote server
hosting the website, e.g., a university server (McGill’s, in my case). For this
task, we’ll be using <a href="http://www.openssh.org/">ssh</a> and <a href="http://rsync.samba.org/">rsync</a>.</p>

<!-- more -->

<h2 id="pushing-to-server">Pushing to server</h2>

<p>Alright, so you’ve got a website all set up, and the directory structure looks
something like this.</p>

<div class="highlighter-rouge"><pre class="highlight"><code>after-body.html
before-body.html
favicon.png
files
    \--- handout-stuff.pdf
    \--- handout-junk.pdf
header.html
images
    \--- pic-of-me.jpg
index.html
index.markdown
md2html.sh
mystyle.css
</code></pre>
</div>

<p>(Most of these files are optional; all you really need is <code class="highlighter-rouge">index.markdown</code>,
<code class="highlighter-rouge">index.html</code>, and <code class="highlighter-rouge">md2htmlsh</code>. But for completeness, I’ll assume we’re dealing
with a CSS stylesheet, some images, downloadable files, etc.)</p>

<p>Essentially, we want to transfer the all necessary website components from a
local PC location to a remote server. The way we do this is with ssh (actually,
the suite of utilities provided by OpenSSH, including <code class="highlighter-rouge">ssh</code> and <code class="highlighter-rouge">scp</code> (secure
copy).)</p>

<h3 id="ssh">SSH</h3>

<p>You know, instead of talking about “you” or “me”, it’ll be easier to talk about
a hypothetical third person. Meet Bob. Bob’s website is located on his PC in
the directory <code class="highlighter-rouge">/home/bob/website</code>. Bob attends ABC University, which has been
kind enough to give Bob some server space for his website. They also tell Bob
he can access his server space remotely using “secure shell access”.</p>

<p>What this means is that, while Bob is sitting on his couch in his apartment on
his own PC, he can access/log onto his university server. How so? With <a href="http://www.openssh.org/">ssh</a>,
a secure access utility provided OpenSSH.</p>

<h4 id="ssh--ing-manually">ssh–ing manually</h4>

<p>Let’s assume that Bob’s university login name is <code class="highlighter-rouge">bob22</code>, because he’s the 22nd
Bob, and so his login name is <code class="highlighter-rouge">bob22@abc.edu</code>. Then he can access the server
with the following simple command (recall that <code class="highlighter-rouge">$</code> is the command–line prompt;
don’t type it):</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="gp">$ </span>ssh bob22@abc.edu
</code></pre>
</div>

<p>Pretty easy. After executing this command, Bob will be prompted for his
university password, which happens to be <code class="highlighter-rouge">iluvssh</code> (but don’t tell anyone). He
enters the password and is greeted with something like:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>Welcome to ABC University's server! Blah blah blah, GNU/Linux license
stuff, no warranty, yada yada.

bob22@abc:~$
</code></pre>
</div>

<p>Bob went from being inside his personal home directory to being on his home
directory on his uni server, hence why <code class="highlighter-rouge">$</code> is the prompt in both cases. Note,
however, that Bob’s local home directory is <code class="highlighter-rouge">/home/bob</code>, whereis his remote uni
one is (probably) <code class="highlighter-rouge">/home/bob22</code>.</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="gp">bob22@abc:~$ </span><span class="nb">echo</span> <span class="nv">$HOME</span>
/home/bob22
</code></pre>
</div>

<p>Bob looks around in his home directory, and he notices two folders:</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="gp">bob22@abc:~$ </span>ls
private public_html
</code></pre>
</div>

<p>Presumably, <code class="highlighter-rouge">private</code> is for stuff that no other students/users of that server
has access to; <code class="highlighter-rouge">public_html</code> is where Bob needs to put his website. But how
does he do that? Right now, he’s “inside” his uni home, with no way look at his
PC home, except in another shell, but then in that shell he would have no way
to look at his uni home. That is, the two shells could not “communicate”, as it
were.</p>

<h4 id="scp">scp</h4>

<p>Enter <code class="highlighter-rouge">scp</code>, or secure copy. First Bob exits from his uni server with <code class="highlighter-rouge">exit</code>,
putting him back into his ordinary PC home. Now he can do this:</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="gp">$ </span>scp ~/website/index.html bob22@abc.edu:/home/bob22/public_html
</code></pre>
</div>

<p>This command (securely) copies the file <code class="highlighter-rouge">index.html</code> from the local home
directory, <code class="highlighter-rouge">/home/bob</code>, over to Bob’s university home directory, <code class="highlighter-rouge">/home/bob22</code>,
and into the <code class="highlighter-rouge">public_html</code> directory.</p>

<p>But there’s a snag: Bob has to enter his password again. How annoying. In fact,
each time Bob runs <code class="highlighter-rouge">ssh</code> or <code class="highlighter-rouge">scp</code>, he has to enter his password. If only there
were a way for Bob’s uni server to recognize that it’s <em>Bob</em> (or Bob’s PC)
requesting access, so that Bob doesn’t always have to type <code class="highlighter-rouge">iluvssh</code>.</p>

<h4 id="ssh-keys">ssh keys</h4>

<p>Well, there is a way: ssh identity files (or keys). Basically, Bob generates a
pair of keys—one private, which he keeps on his PC, and one public, which he
sends over to the server. The server, since it has Bob’s public key, can
recognize and grant access to anyone having Bob’s private key. Obviously, Bob
should not share the private key (the public one doesn’t matter).</p>

<p>The command for all this is:</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="gp">$ </span>ssh-keygen -f abc -t rsa -C <span class="s1">'ABC University'</span>
</code></pre>
</div>

<p>Legend:</p>

<ul>
  <li><code class="highlighter-rouge">-f</code> specifies the outut <strong>f</strong>ilename.</li>
  <li><code class="highlighter-rouge">-t</code> specifies the encryption <strong>t</strong>ype. I use RSA, but DSA is fine too.</li>
  <li><code class="highlighter-rouge">-C</code> is an optional <strong>c</strong>omment; use it to describe what the key is for.</li>
</ul>

<p>(You’ll be asked to specify a passphrase, which is optional.)</p>

<p>After running this command, Bob has two files: <code class="highlighter-rouge">abc</code>, his personal identity
file, and <code class="highlighter-rouge">abc.pub</code>, the public one. He should first put <code class="highlighter-rouge">abc</code> into the
directory <code class="highlighter-rouge">~/.ssh</code>, where any other keys are located, too:</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="gp">$ </span>mkdir ~/.ssh <span class="c"># create this directory, if not already existing</span>
<span class="gp">$ </span>mv abc ~/.ssh/
</code></pre>
</div>

<p>(Bob could also have simply run <code class="highlighter-rouge">ssh-keygen</code> from inside <code class="highlighter-rouge">~/.ssh</code> to begin
with.)</p>

<p>Now he needs to get <code class="highlighter-rouge">abc.pub</code> onto the remote server. That’s easy:</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="gp">$ </span>scp ~/abc.pub bob22@abc.edu:/home/bob22
</code></pre>
</div>

<p>But that’s not quite enough. The way OpenSSH works is that the public key has
to be concatenated to a file <code class="highlighter-rouge">authorized_keys</code>, located in the remote <code class="highlighter-rouge">~/.ssh</code>,
which contains all public keys needed by Bob’s remote server. To do that, Bob
must ssh one more time onto the server, create <code class="highlighter-rouge">~/.ssh</code> if necessary, append
<code class="highlighter-rouge">abc.pub</code> to <code class="highlighter-rouge">authorized_keys</code>, change the permissions on <code class="highlighter-rouge">authorized_keys</code> so
that only Bob can read and write to it, and finally delete <code class="highlighter-rouge">abc.pub</code>.</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="gp">$ </span>ssh bob22@abc.edu
Welcome! ...
<span class="gp">bob22@abc:~$ </span>ls
abc.pub private public_html
<span class="gp">bob22@abc:~$ </span>mkdir ~/.ssh
<span class="gp">bob22@abc:~$ </span>cat ~/abc.pub &gt;&gt; ~/.ssh/authorized_keys
<span class="gp">bob22@abc:~$ </span>chmod 600 ~/.ssh/authorized_keys
<span class="gp">bob22@abc:~$ </span>rm abc.pub
<span class="gp">bob22@abc:~$ </span><span class="nb">exit</span>
</code></pre>
</div>

<p>If all went well, Bob should now be able to ssh onto the server without
typing <code class="highlighter-rouge">iluvssh</code> every time. Cool!</p>

<h4 id="ssh-config-file">ssh config file</h4>

<p>But there’s another snag: What if Bob’s username were actually</p>

<div class="highlighter-rouge"><pre class="highlight"><code>reallylongfirstname.superlonglastname946537
</code></pre>
</div>

<p>and/or what if his university’s domain name were actually</p>

<div class="highlighter-rouge"><pre class="highlight"><code>abcdefghijklmnopqrstuvwxyz@abc.de.fghi.jklm.no.pqrst.uvwx.yz.edu
</code></pre>
</div>

<p>It’d be pretty annoying to type all that out every time Bob wanted to <code class="highlighter-rouge">ssh</code>
onto the server or <code class="highlighter-rouge">scp</code> something over to it. Sure, Bob could create a shell
alias for it, but ssh offers an easy solution: an ssh config file. Bob can
simply create a file <code class="highlighter-rouge">~/.ssh/config</code> that looks like this:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>Host abc
    User bob22
    HostName abc.edu
    IdentityFile ~/.ssh/abc
</code></pre>
</div>

<p>The keywords are pretty straightforward. The only one worth discussing is
<code class="highlighter-rouge">Host</code>: this is the name that this particular entry goes by, and it’s that name
which, when used in a shell or script, is equivalent to <code class="highlighter-rouge">bob22@abc.edu</code>. In
other words, typing</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="gp">$ </span>ssh abc
</code></pre>
</div>

<p>is equivalent to typing</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="gp">$ </span>ssh bob22@abc.edu
</code></pre>
</div>

<p>Similarly, typing</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="gp">$ </span>scp blah.txt abc:/home/bob22
</code></pre>
</div>

<p>is equivalent to typing</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="gp">$ </span>scp blah.txt bob22@abc.edu:/home/bob22
</code></pre>
</div>

<p>You can see how a config file drastically simplifies things.</p>

<p>Now all Bob has to do is <code class="highlighter-rouge">scp</code> over all the necessary website files. He could
do this manually, or write a script. If he wrote a script, then any time he
edited or added a file locally, he could then run the script to update the
remote website directory. However, if I’m not mistaken, <em>all</em> files, even those
untouched, would be copied over every time. There may be a smart way to use
<code class="highlighter-rouge">scp</code> to handle this problem, but in any case, I prefer rsync for all major
copying/backing up of anything.</p>

<h3 id="rsync">Rsync</h3>

<p>Rsync is a great tool for copying or backing up data. Here are some advantages
that it has over <code class="highlighter-rouge">scp</code>:</p>

<ol>
  <li>It’s smart enough to skip transferring files that are “the same”, in some
sense, on the local and remote machines: e.g., if they have the same name and
size, and/or same last edit timestamp, and/or same md5sum check, etc.</li>
  <li>When it copies over files that have been changed, it only transfers the
changes, which speeds things up dramatically.</li>
  <li>It allows you to specify an “exclude” file that lists files it should
exclude from transfer. (Conversely, you can specify an “include” file that
lists the <em>only</em> files that should be transferred.)</li>
  <li>Importantly for our (or Bob’s) purposes, it seamlessly integrates ssh.</li>
</ol>

<p>…and so forth.</p>

<p>Since this post is already pretty long, I’ll wrap up with a simple rsync script
called <code class="highlighter-rouge">push-website.sh</code>, stored in Bob’s <code class="highlighter-rouge">~/website</code> directory, which
transfers Bob’s website from his local PC to his remote server’s <code class="highlighter-rouge">public_html</code>
directory. It integrates an include file as well as a log file, both of which
are stored in a (hidden) directory <code class="highlighter-rouge">~/website/.push-website</code>.</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="c">#!/bin/bash</span>

<span class="nv">SRC</span><span class="o">=</span><span class="s2">"</span><span class="nv">$HOME</span><span class="s2">/website"</span>
<span class="nv">DEST</span><span class="o">=</span><span class="s2">"abc:/home/bob22/public_html"</span>
<span class="nv">EXCL</span><span class="o">=</span><span class="s2">"</span><span class="nv">$SRC</span><span class="s2">/.push-website/exclude-list"</span>
<span class="nv">LOG</span><span class="o">=</span><span class="s2">"</span><span class="nv">$SRC</span><span class="s2">/.push-website/log"</span>

rsync <span class="se">\</span>
    -avhhh <span class="se">\</span>
    --exclude-from<span class="o">=</span><span class="nv">$EXCL</span> <span class="se">\</span>
    --log-file<span class="o">=</span><span class="nv">$LOG</span> <span class="se">\</span>
    <span class="nv">$SRC</span>/ <span class="nv">$DEST</span>/
</code></pre>
</div>

<p>Legend:</p>

<ul>
  <li><code class="highlighter-rouge">-a</code> means <strong>a</strong>rchive.</li>
  <li><code class="highlighter-rouge">-v</code> means <strong>v</strong>erbose (make rsync say what it’s doing while it runs).</li>
  <li><code class="highlighter-rouge">-hhh</code> means extra <strong>h</strong>uman readable, e.g., “2M” instead of “2000”.</li>
</ul>

<p><strong>Important.</strong> The forward slash, <code class="highlighter-rouge">/</code>, in <code class="highlighter-rouge">$SRC/</code> is crucial.  It tells rsync
to transfer the <em>contents</em> of the source directory into the destination
directory, rather than transfering <code class="highlighter-rouge">$SRC</code> itself. See <code class="highlighter-rouge">man rsync</code> for more
info. It’s useful to read about all the rsync options.</p>

<p>So now Bob can update his site very simply by editing <code class="highlighter-rouge">index.markdown</code>, running
<code class="highlighter-rouge">md2html.sh</code> to convert to HTML, and running <code class="highlighter-rouge">push-website.sh</code> to push the
changes to his university server.</p>

<div class="highlighter-rouge"><pre class="highlight"><code>~/website <span class="nv">$ </span>vim index.markdown      <span class="c"># edit, edit, edit, save, quit</span>
~/website <span class="nv">$ </span>./md2html.sh            <span class="c"># convert to HTML</span>
~/website <span class="nv">$ </span>./push-website.sh       <span class="c"># push changes to remote server</span>
</code></pre>
</div>

<p>Nice! By the way, here are some things that are good to keep in the exclude
file:</p>

<ul>
  <li><code class="highlighter-rouge">index.markdown</code></li>
  <li><code class="highlighter-rouge">header.html</code></li>
  <li><code class="highlighter-rouge">before-body.html</code></li>
  <li><code class="highlighter-rouge">after-body.html</code></li>
  <li><code class="highlighter-rouge">footer.html</code></li>
  <li>etc.</li>
</ul>

<p>All of that is already integrated into <code class="highlighter-rouge">index.html</code> when <code class="highlighter-rouge">md2html.sh</code> is
executed.  In fact, you also don’t need to transfer over <code class="highlighter-rouge">md2html.sh</code> or
<code class="highlighter-rouge">push-website.sh</code> either, or the directory <code class="highlighter-rouge">.push-website</code>.</p>

<p>Really, you just need to transfer the main HTML file <code class="highlighter-rouge">index.html</code>, the
stylesheet <code class="highlighter-rouge">mystyle.css</code>, and any downloadables, like stuff in <code class="highlighter-rouge">images/</code> and
<code class="highlighter-rouge">files/</code>.</p>

<p><strong>Important.</strong> Make sure that the permissions of all files are properly set on
the remote server. In particular, things that you want to be viewed (pages,
images) or downloaded (files) must allow read and (maybe) execute privileges
set. If an image fails to show up, or if clicking a link lands you on a
“Forbidden” page, then the permissions are not set right.</p>

<p>In the last part of this series, I’ll explain how to version control your
website, scripts, etc. using git and GitHub. The setup will be a lot like the
above, because sites like GitHub and BitBucket use ssh for remote access. We’ll
simply generate a new ssh key pair, plop the public one onto GitHub, and add a
github entry in <code class="highlighter-rouge">~/.ssh/config</code>. Easy stuff.</p>

  </div>

</article>

      </div>
    </div>

    <footer class="site-footer">
  <div class="wrapper">
    <div class="footer-wrapper">
      &copy; Brian Buccola. Powered by <a
         href="https://jekyllrb.com/">Jekyll</a> and <a
         href="https://github.com/">GitHub</a>.
    </div>
  </div>
</footer>


  </body>

</html>
